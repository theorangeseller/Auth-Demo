{% extends "base.html" %}

{% block title %}Dashboard - {{ method|title }} Authentication{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900">
            {% if method == 'oauth2' %}
                <i class="fas fa-key text-blue-600 mr-3"></i>OAuth 2.0
            {% elif method == 'oidc' %}
                <i class="fas fa-id-card text-green-600 mr-3"></i>OpenID Connect
            {% elif method == 'saml' %}
                <i class="fas fa-shield-alt text-purple-600 mr-3"></i>SAML SSO
            {% endif %}
            Authentication Success
        </h1>
        <p class="mt-2 text-gray-600">Authentication completed successfully using {{ method|upper }}</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- User Information -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">User Information</h2>
            
            <div class="space-y-4">
                {% if user.name %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        Display Name
                        <i class="fas fa-info-circle text-gray-400 ml-1" title="User's full display name"></i>
                    </label>
                    <p class="text-lg text-gray-900">{{ user.name }}</p>
                    <p class="text-xs text-gray-500">From SAML attribute: displayname, name, or constructed from givenname + surname</p>
                </div>
                {% endif %}
                
                {% if user.preferred_username %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        User Principal Name (UPN)
                        <i class="fas fa-info-circle text-gray-400 ml-1" title="Unique login identifier"></i>
                    </label>
                    <p class="text-lg text-gray-900">{{ user.preferred_username }}</p>
                    <p class="text-xs text-gray-500">From SAML attribute: userprincipalname or nameid</p>
                </div>
                {% endif %}
                
                {% if user.email %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        Email Address
                        <i class="fas fa-info-circle text-gray-400 ml-1" title="User's email address"></i>
                    </label>
                    <p class="text-lg text-gray-900">{{ user.email }}</p>
                    <p class="text-xs text-gray-500">From SAML attribute: emailaddress, mail, or email</p>
                </div>
                {% endif %}
                
                {% if user.given_name or user.family_name %}
                <div class="grid grid-cols-2 gap-4">
                    {% if user.given_name %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Given Name</label>
                        <p class="text-gray-900">{{ user.given_name }}</p>
                        <p class="text-xs text-gray-500">From SAML: givenname</p>
                    </div>
                    {% endif %}
                    {% if user.family_name %}
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Family Name</label>
                        <p class="text-gray-900">{{ user.family_name }}</p>
                        <p class="text-xs text-gray-500">From SAML: surname</p>
                                     </div>
                 {% endif %}

                 <!-- Azure AD Session Education -->
                 <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 mt-4">
                     <h4 class="text-sm font-semibold text-amber-800 mb-3">
                         <i class="fas fa-eye-slash text-amber-600 mr-1"></i>The "Hidden" Azure AD Session Token
                     </h4>
                     <div class="text-xs text-amber-700 space-y-3">
                         <div>
                             <strong>What you're probably thinking of:</strong>
                             <p class="mt-1">When you logged into Azure AD, it gave your browser a session cookie/token. This is what proves you're authenticated.</p>
                         </div>
                         
                         <div class="bg-amber-100 rounded p-2 border-l-2 border-amber-400">
                             <strong>üîí Why this app can't show that token:</strong>
                             <ul class="list-disc list-inside mt-1 space-y-1">
                                 <li><strong>Security:</strong> Azure AD session tokens are httpOnly cookies</li>
                                 <li><strong>Scope:</strong> They're bound to *.microsoftonline.com domain</li>
                                 <li><strong>Privacy:</strong> Your login credentials never leave Azure AD</li>
                                 <li><strong>Design:</strong> Apps only get identity assertions, not auth tokens</li>
                             </ul>
                         </div>

                         <div>
                             <strong>What this app actually receives:</strong>
                             <div class="mt-2 space-y-1">
                                 <div class="flex items-center">
                                     <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">‚úì</span>
                                     <span>SAML Assertion (XML) - shown above</span>
                                 </div>
                                 <div class="flex items-center">
                                     <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">‚úì</span>
                                     <span>User attributes (name, email, etc.)</span>
                                 </div>
                                 <div class="flex items-center">
                                     <span class="bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">‚úó</span>
                                     <span>Your Azure AD login token/session</span>
                                 </div>
                                 <div class="flex items-center">
                                     <span class="bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">‚úó</span>
                                     <span>Your password or MFA codes</span>
                                 </div>
                             </div>
                         </div>

                                                   <div class="bg-blue-100 rounded p-2 border-l-2 border-blue-400">
                             <strong>üéì Educational Summary:</strong>
                             <p class="mt-1">Azure AD authenticates YOU, then creates a signed statement (SAML assertion) about your identity for THIS APP. The app trusts the assertion because it's cryptographically signed by Azure AD, not because it has access to your login session.</p>
                         </div>

                         <!-- Visual Token/Session Diagram -->
                         <div class="mt-4 bg-white rounded border p-3">
                             <h5 class="text-xs font-semibold text-gray-800 mb-2">üîç Token/Session Flow Visualization:</h5>
                             <div class="space-y-2 text-xs">
                                 <div class="flex items-center justify-between bg-blue-50 rounded p-2">
                                     <div class="flex items-center">
                                         <span class="bg-blue-500 text-white rounded px-2 py-1 text-xs mr-2">You</span>
                                         <span>‚Üí Login credentials ‚Üí</span>
                                     </div>
                                     <div class="flex items-center">
                                         <span class="bg-blue-600 text-white rounded px-2 py-1 text-xs">Azure AD</span>
                                     </div>
                                 </div>
                                 
                                 <div class="flex items-center justify-between bg-gray-50 rounded p-2">
                                     <div class="flex items-center">
                                         <span class="bg-gray-500 text-white rounded px-2 py-1 text-xs mr-2">Browser</span>
                                         <span>‚Üê Session cookie ‚Üê</span>
                                     </div>
                                     <div class="flex items-center">
                                         <span class="bg-blue-600 text-white rounded px-2 py-1 text-xs">Azure AD</span>
                                     </div>
                                 </div>
                                 
                                 <div class="flex items-center justify-between bg-green-50 rounded p-2">
                                     <div class="flex items-center">
                                         <span class="bg-green-500 text-white rounded px-2 py-1 text-xs mr-2">This App</span>
                                         <span>‚Üê SAML Assertion ‚Üê</span>
                                     </div>
                                     <div class="flex items-center">
                                         <span class="bg-blue-600 text-white rounded px-2 py-1 text-xs">Azure AD</span>
                                     </div>
                                 </div>
                                 
                                 <div class="bg-red-50 rounded p-2 mt-2">
                                     <div class="flex items-center">
                                         <span class="bg-red-500 text-white rounded px-2 py-1 text-xs mr-2">This App</span>
                                         <span class="text-red-700">‚úó Cannot see your Azure AD session cookie</span>
                                     </div>
                                 </div>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
             {% endif %}
                
                {% if user.name_id %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        SAML NameID
                        <i class="fas fa-info-circle text-gray-400 ml-1" title="SAML-specific unique identifier"></i>
                    </label>
                    <p class="text-sm text-gray-600 font-mono break-all">{{ user.name_id }}</p>
                    <p class="text-xs text-gray-500">Unique identifier provided by Azure AD in SAML assertion</p>
                </div>
                {% endif %}
                
                {% if user.oid %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">Object ID</label>
                    <p class="text-sm text-gray-600 font-mono">{{ user.oid }}</p>
                    <p class="text-xs text-gray-500">Azure AD internal user identifier</p>
                </div>
                {% endif %}
                
                {% if user.sub %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">Subject ID</label>
                    <p class="text-sm text-gray-600 font-mono">{{ user.sub }}</p>
                </div>
                {% endif %}
                
                {% if user.tid %}
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tenant ID</label>
                    <p class="text-sm text-gray-600 font-mono">{{ user.tid }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- SAML Response and Educational Information -->
        <div class="bg-white rounded-lg shadow-md p-6">
            {% if method == 'saml' %}
            <h2 class="text-xl font-semibold text-gray-900 mb-6">
                <i class="fas fa-file-code text-purple-600 mr-2"></i>SAML Authentication Details
            </h2>
            
            <!-- SAML Authentication Process Education -->
            <div class="mb-6 bg-blue-50 border-l-4 border-blue-400 p-4">
                <h3 class="text-sm font-semibold text-blue-800 mb-3">
                    <i class="fas fa-graduation-cap mr-1"></i>How SAML Authentication Actually Works
                </h3>
                
                <!-- Key Concept: No "Access Tokens" in SAML -->
                <div class="mb-4 bg-white rounded p-3 border-l-2 border-yellow-400">
                    <h4 class="text-xs font-semibold text-gray-800 mb-2">
                        üîë Key Concept: SAML doesn't use "access tokens"
                    </h4>
                    <div class="text-xs text-gray-700 space-y-1">
                        <p><strong>SAML Assertions:</strong> XML statements about user identity (who you are)</p>
                        <p><strong>OAuth Tokens:</strong> JSON credentials for API access (what you can do)</p>
                        <p><strong>Your Azure AD Session:</strong> Browser cookie/token (hidden from this app)</p>
                    </div>
                </div>

                <!-- Authentication Flow -->
                <div class="mb-4">
                    <h4 class="text-xs font-semibold text-blue-800 mb-2">Azure AD Authentication Process:</h4>
                    <div class="space-y-2 text-xs text-blue-700">
                        <div class="flex items-start">
                            <span class="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 mt-0.5 flex-shrink-0">1</span>
                            <div>
                                <strong>User Session Check:</strong> Azure AD checks if user has valid session
                                <p class="text-blue-600 mt-1">If no session ‚Üí prompts for username/password/MFA</p>
                                <p class="text-blue-600">If valid session ‚Üí skips to step 3</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 mt-0.5 flex-shrink-0">2</span>
                            <div>
                                <strong>Authentication:</strong> User proves identity to Azure AD
                                <p class="text-blue-600 mt-1">Azure AD validates credentials and creates internal session</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <span class="bg-blue-200 text-blue-800 rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold mr-2 mt-0.5 flex-shrink-0">3</span>
                            <div>
                                <strong>SAML Assertion Creation:</strong> Azure AD creates signed XML about authenticated user
                                <p class="text-blue-600 mt-1">This app receives the assertion, not the user's login credentials</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Comparison Table -->
                <div class="grid grid-cols-2 gap-4 text-xs">
                    <div class="bg-purple-50 rounded p-2">
                        <strong class="text-purple-800">SAML (Identity-focused):</strong>
                        <ul class="list-disc list-inside mt-1 space-y-1 text-purple-700">
                            <li>XML assertions (not tokens)</li>
                            <li>Certificate-based signatures</li>
                            <li>One-time identity statements</li>
                            <li>Enterprise SSO standard</li>
                            <li>User already authenticated at IdP</li>
                        </ul>
                    </div>
                    <div class="bg-green-50 rounded p-2">
                        <strong class="text-green-800">OAuth/OIDC (API access):</strong>
                        <ul class="list-disc list-inside mt-1 space-y-1 text-green-700">
                            <li>JSON Web Tokens (JWT)</li>
                            <li>Secret/signature-based</li>
                            <li>Reusable access credentials</li>
                            <li>API authorization standard</li>
                            <li>Tokens enable ongoing access</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- SAML Attributes -->
            {% if user.saml_attributes %}
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">
                    <i class="fas fa-tags text-purple-600 mr-1"></i>SAML Attributes Received
                </h3>
                <div class="bg-gray-50 rounded-md p-3 max-h-32 overflow-y-auto">
                    <div class="grid grid-cols-1 gap-2 text-xs">
                        {% for attr_name, attr_value in user.saml_attributes.items() %}
                        <div class="flex justify-between">
                            <span class="font-mono text-purple-600">{{ attr_name }}:</span>
                            <span class="text-gray-800 ml-2 truncate">{{ attr_value }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <i class="fas fa-info-circle mr-1"></i>These attributes are sent by Azure AD in the SAML assertion
                </p>
            </div>
            {% endif %}

            <!-- SAML Flow Timeline -->
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-gray-800 mb-3">
                    <i class="fas fa-route text-purple-600 mr-1"></i>SAML SSO Flow Completed
                </h3>
                <div class="space-y-2 text-xs">
                    <div class="flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">1</span>
                        <span>User clicked "Test SAML SSO" ‚Üí AuthnRequest generated</span>
                    </div>
                    <div class="flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">2</span>
                        <span>Redirected to Azure AD with DEFLATE-compressed SAML request</span>
                    </div>
                    <div class="flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">3</span>
                        <span>User authenticated with Azure AD (or was already signed in)</span>
                    </div>
                    <div class="flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">4</span>
                        <span>Azure AD posted SAML Response to callback URL</span>
                    </div>
                    <div class="flex items-center">
                        <span class="bg-green-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs mr-2">5</span>
                        <span>App parsed SAML assertion and extracted user data</span>
                    </div>
                </div>
            </div>

            {% if session.saml_response %}
            <!-- SAML Response Details -->
            <div class="space-y-4">
                <div>
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Full SAML Response (Base64 Decoded)</label>
                        <button onclick="toggleElement('saml-response')" class="text-xs bg-purple-600 text-white px-2 py-1 rounded hover:bg-purple-700">
                            <i class="fas fa-eye mr-1"></i>Show/Hide
                        </button>
                    </div>
                    <div id="saml-response" class="hidden">
                        <!-- SAML Response vs Assertion Education -->
                        <div class="mb-3 bg-blue-50 border border-blue-200 rounded p-3">
                            <h5 class="text-xs font-semibold text-blue-800 mb-2">
                                <i class="fas fa-info-circle mr-1"></i>SAML Response vs SAML Assertion
                            </h5>
                            <div class="text-xs text-blue-700 space-y-2">
                                <div>
                                    <strong>üéÅ SAML Response (the envelope):</strong>
                                    <p>The complete XML document Azure AD sends, including metadata, signatures, and wrapper elements</p>
                                </div>
                                <div>
                                    <strong>üíé SAML Assertion (the content):</strong>
                                    <p>The core part containing your identity claims - embedded within the Response</p>
                                </div>
                                <div class="bg-blue-100 rounded p-2">
                                    <strong>What you see below:</strong> The full SAML Response XML (envelope + assertion + signature)
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <textarea readonly rows="8" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 font-mono text-xs">{{ session.saml_response.saml_response }}</textarea>
                            <button onclick="copyToClipboard(document.querySelector('#saml-response textarea').value)" class="absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <div class="mt-2 text-xs text-gray-600 bg-yellow-50 border-l-4 border-yellow-400 p-2">
                            <div class="mb-3">
                                <strong>üîê SAML Signature Verification</strong>
                            </div>
                            
                            {% if session.saml_response.signature_verification %}
                            <!-- Actual Signature Verification Results -->
                            <div class="space-y-3">
                                {% if session.saml_response.signature_verification.verified %}
                                <div class="bg-green-50 border border-green-200 rounded p-3">
                                    <h6 class="font-semibold text-green-800 mb-2">
                                        ‚úÖ Signature Verification: PASSED
                                    </h6>
                                    
                                    {% if session.saml_response.signature_verification.certificate_used %}
                                    <div class="mb-2">
                                        <strong class="text-green-700">Certificate Used:</strong>
                                        <div class="text-xs text-green-600 mt-1 space-y-1">
                                            <div><strong>Index:</strong> {{ session.saml_response.signature_verification.certificate_used.index }}</div>
                                            <div><strong>Subject:</strong> {{ session.saml_response.signature_verification.certificate_used.subject }}</div>
                                            <div><strong>Valid Until:</strong> {{ session.saml_response.signature_verification.certificate_used.not_after }}</div>
                                        </div>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="bg-green-100 rounded p-2">
                                        <strong class="text-green-700">Verification Steps:</strong>
                                        <ul class="mt-1 space-y-1">
                                            {% for detail in session.saml_response.signature_verification.details %}
                                            <li class="text-green-600">{{ detail }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                                {% else %}
                                <div class="bg-red-50 border border-red-200 rounded p-3">
                                    <h6 class="font-semibold text-red-800 mb-2">
                                        ‚ùå Signature Verification: FAILED
                                    </h6>
                                    
                                    {% if session.saml_response.signature_verification.error %}
                                    <div class="mb-2">
                                        <strong class="text-red-700">Error:</strong>
                                        <p class="text-red-600 mt-1">{{ session.saml_response.signature_verification.error }}</p>
                                    </div>
                                    {% endif %}
                                    
                                    {% if session.saml_response.signature_verification.details %}
                                    <div class="bg-red-100 rounded p-2">
                                        <strong class="text-red-700">Verification Details:</strong>
                                        <ul class="mt-1 space-y-1">
                                            {% for detail in session.saml_response.signature_verification.details %}
                                            <li class="text-red-600">{{ detail }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <div class="bg-blue-50 border border-blue-200 rounded p-2">
                                    <strong class="text-blue-700">üéì Educational Note:</strong>
                                    <p class="text-blue-600 mt-1">This demo implements basic SAML signature verification using 
                                    {% if session.saml_response.signature_verification.certificate_source == 'uploaded_certificates' %}
                                    <strong>your uploaded certificate</strong>. This shows how manual certificate management works!
                                    {% else %}
                                    <strong>Azure AD's public certificates from federation metadata</strong>. This shows how automatic certificate discovery works!
                                    {% endif %}
                                    This helps you understand how SAML security works in practice!</p>
                                </div>
                            </div>
                            {% else %}
                            <!-- No Signature Verification Available -->
                            <div class="space-y-2">
                                <div class="bg-orange-50 border border-orange-200 rounded p-2">
                                    <strong class="text-orange-700">‚ö†Ô∏è No Signature Verification Available</strong>
                                    <p class="text-orange-600 mt-1">Signature verification requires federation metadata with signing certificates. 
                                    {% if not session.get('federation_metadata') %}
                                    Federation metadata was not loaded for this session.
                                    {% elif not session.federation_metadata.get('signing_certificates') %}
                                    No signing certificates found in federation metadata.
                                    {% endif %}
                                    </p>
                                </div>
                                
                                <!-- Optional Certificate Upload Feature -->
                                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <h6 class="font-semibold text-blue-800">
                                            üîê Upload SAML Signing Certificate (Optional)
                                        </h6>
                                        <span class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">Nice to Have</span>
                                    </div>
                                    
                                    <p class="text-xs text-blue-700 mb-3">
                                        You can download the SAML signing certificate from Azure AD and upload it here for signature verification. 
                                        This is an educational feature to demonstrate SAML security.
                                    </p>
                                    
                                    <div class="space-y-2">
                                        <div>
                                            <input type="file" id="certificateFile" accept=".cer,.crt,.pem,.txt" class="text-xs" />
                                        </div>
                                        <button onclick="uploadCertificate()" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">
                                            <i class="fas fa-upload mr-1"></i>Upload Certificate
                                        </button>
                                        <div id="uploadResult" class="hidden"></div>
                                    </div>
                                    
                                    <div class="mt-2 text-xs text-blue-600 bg-blue-100 rounded p-2">
                                        <strong>üí° How to get the certificate:</strong>
                                        <ol class="list-decimal list-inside mt-1 space-y-1">
                                            <li>Go to Azure AD ‚Üí Enterprise Applications ‚Üí Your App</li>
                                            <li>Navigate to Single sign-on ‚Üí SAML Signing Certificate</li>
                                            <li>Click "Base64 certificate download" or "PEM certificate download"</li>
                                            <li>Upload the downloaded file here</li>
                                        </ol>
                                    </div>
                                </div>
                                
                                <div>
                                    <strong>What should happen in production:</strong>
                                    <ul class="list-disc list-inside mt-1 space-y-1 text-gray-600">
                                        <li>Extract Azure AD's public certificate from federation metadata</li>
                                        <li>Verify the XML digital signature using that certificate</li>
                                        <li>Check assertion timestamps and conditions</li>
                                        <li>Validate the assertion was intended for this app</li>
                                    </ul>
                                </div>
                                
                                {% if session.saml_response.parsing_method == 'Real SAML Response' %}
                                <div class="bg-green-50 border border-green-200 rounded p-2">
                                    <strong class="text-green-700">‚úÖ Real Azure AD Response:</strong>
                                    <p class="text-green-600 mt-1">This is an actual signed SAML assertion from Azure AD with real certificates and signatures.</p>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    {% if session.saml_response.relay_state %}
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Relay State</label>
                        <p class="text-gray-900 font-mono text-xs">{{ session.saml_response.relay_state }}</p>
                        <p class="text-xs text-gray-500">Maintains application state across SSO</p>
                    </div>
                    {% endif %}
                    
                    {% if session.saml_response.timestamp %}
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Response Time</label>
                        <p class="text-gray-900 text-xs">{{ session.saml_response.timestamp }}</p>
                        <p class="text-xs text-gray-500">When SAML response was processed</p>
                    </div>
                    {% endif %}
                    
                    {% if session.saml_response.original_request_id %}
                    <div>
                        <label class="block text-xs font-medium text-gray-700">Request ID</label>
                        <p class="text-gray-900 font-mono text-xs">{{ session.saml_response.original_request_id }}</p>
                        <p class="text-xs text-gray-500">Links response to original AuthnRequest</p>
                    </div>
                    {% endif %}
                    
                    {% if user.name_id %}
                    <div>
                        <label class="block text-xs font-medium text-gray-700">SAML NameID</label>
                        <p class="text-gray-900 font-mono text-xs break-all">{{ user.name_id }}</p>
                        <p class="text-xs text-gray-500">Unique identifier from identity provider</p>
                    </div>
                    {% endif %}
                </div>

                                 {% if session.saml_response.assertion_consumer_url %}
                 <div>
                     <label class="block text-xs font-medium text-gray-700">Assertion Consumer URL</label>
                     <p class="text-gray-900 font-mono text-xs break-all">{{ session.saml_response.assertion_consumer_url }}</p>
                     <p class="text-xs text-gray-500">Where Azure AD posted the SAML response</p>
                 </div>
                 {% endif %}
                 
                 {% if session.saml_response.response_method %}
                 <div>
                     <label class="block text-xs font-medium text-gray-700">HTTP Method</label>
                     <p class="text-gray-900 font-mono text-xs">{{ session.saml_response.response_method }}</p>
                     <p class="text-xs text-gray-500">SAML responses use HTTP POST</p>
                 </div>
                 {% endif %}
                </div>

                <!-- SAML Assertion Display -->
                {% if session.saml_response.saml_assertion %}
                <div class="mt-4">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">
                            <i class="fas fa-gem text-purple-600 mr-1"></i>SAML Assertion Only (The Content)
                        </label>
                        <button onclick="toggleElement('saml-assertion')" class="text-xs bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">
                            <i class="fas fa-eye mr-1"></i>Show/Hide
                        </button>
                    </div>
                    
                    <div id="saml-assertion" class="hidden">
                        <!-- Educational Note -->
                        <div class="mb-3 bg-green-50 border border-green-200 rounded p-3">
                            <h5 class="text-xs font-semibold text-green-800 mb-2">
                                <i class="fas fa-graduation-cap mr-1"></i>This is the SAML Assertion - The Core Content
                            </h5>
                            <div class="text-xs text-green-700 space-y-2">
                                <div>
                                    <strong>üíé What you see below:</strong> Just the SAML assertion extracted from the full response
                                </div>
                                <div>
                                    <strong>üéØ Key difference:</strong> No envelope elements, no signature wrapper - just the pure identity claims
                                </div>
                                <div class="bg-green-100 rounded p-2">
                                    <strong>Contains:</strong> Subject (NameID), Attributes, Conditions, and AuthnStatement
                                </div>
                            </div>
                        </div>
                        
                        <div class="relative">
                            <textarea readonly rows="6" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 font-mono text-xs">{{ session.saml_response.saml_assertion }}</textarea>
                            <button onclick="copyToClipboard(document.querySelector('#saml-assertion textarea').value)" class="absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        
                        <div class="mt-2 text-xs text-gray-600 bg-green-50 border-l-4 border-green-400 p-2">
                            <strong>üîç What to look for:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li><strong>&lt;saml:Subject&gt;</strong> - Contains your NameID</li>
                                <li><strong>&lt;saml:AttributeStatement&gt;</strong> - Contains all your attributes (name, email, etc.)</li>
                                <li><strong>&lt;saml:AuthnStatement&gt;</strong> - How and when you were authenticated</li>
                                <li><strong>&lt;saml:Conditions&gt;</strong> - When this assertion is valid</li>
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Technical Details -->
                {% if session.saml_response.saml_response_size %}
                <div class="bg-gray-50 border rounded-lg p-3 mt-4">
                    <h4 class="text-xs font-semibold text-gray-700 mb-2">
                        <i class="fas fa-info-circle text-gray-500 mr-1"></i>Technical Details
                    </h4>
                    <div class="grid grid-cols-2 gap-3 text-xs">
                        <div>
                            <span class="text-gray-600">XML Response Size:</span>
                            <span class="font-mono ml-1">{{ session.saml_response.saml_response_size }} bytes</span>
                        </div>
                        {% if session.saml_response.saml_assertion_size %}
                        <div>
                            <span class="text-gray-600">SAML Assertion Size:</span>
                            <span class="font-mono ml-1">{{ session.saml_response.saml_assertion_size }} bytes</span>
                        </div>
                        {% endif %}
                        {% if session.saml_response.compressed_base64_size %}
                        <div>
                            <span class="text-gray-600">Base64 Compressed:</span>
                            <span class="font-mono ml-1">{{ session.saml_response.compressed_base64_size }} chars</span>
                        </div>
                        {% endif %}
                        {% if session.saml_response.user_attributes_count %}
                        <div>
                            <span class="text-gray-600">SAML Attributes:</span>
                            <span class="font-mono ml-1">{{ session.saml_response.user_attributes_count }} found</span>
                        </div>
                        {% endif %}
                        <div>
                            <span class="text-gray-600">Processing:</span>
                            <span class="font-mono ml-1 {{ 'text-green-600' if 'Real' in session.saml_response.parsing_method else 'text-orange-600' }}">
                                {{ session.saml_response.parsing_method }}
                            </span>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="text-center py-8 text-gray-500 border border-dashed border-gray-300 rounded-lg">
                <i class="fas fa-file-alt text-4xl mb-4"></i>
                <p class="font-medium">SAML Response Data Unavailable</p>
                <p class="text-xs">Using demo data for this session</p>
            </div>
            {% endif %}

            {% else %}
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Token Information</h2>
            
            {% if tokens.access_token %}
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                <div class="relative">
                    <textarea readonly rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 font-mono text-xs">{{ tokens.access_token }}</textarea>
                    <button onclick="copyToClipboard('{{ tokens.access_token }}')" class="absolute top-2 right-2 bg-blue-600 text-white px-2 py-1 rounded text-xs hover:bg-blue-700">
                        Copy
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Bearer token for API access</p>
            </div>
            {% endif %}

            {% if tokens.id_token %}
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">ID Token (JWT)</label>
                <div class="relative">
                    <textarea readonly rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 font-mono text-xs">{{ tokens.id_token }}</textarea>
                    <button onclick="copyToClipboard('{{ tokens.id_token }}')" class="absolute top-2 right-2 bg-green-600 text-white px-2 py-1 rounded text-xs hover:bg-green-700">
                        Copy
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Identity information in JWT format</p>
            </div>
            {% endif %}

            {% if tokens.refresh_token %}
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Refresh Token</label>
                <div class="relative">
                    <textarea readonly rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50 font-mono text-xs">{{ tokens.refresh_token }}</textarea>
                    <button onclick="copyToClipboard('{{ tokens.refresh_token }}')" class="absolute top-2 right-2 bg-purple-600 text-white px-2 py-1 rounded text-xs hover:bg-purple-700">
                        Copy
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Token for obtaining new access tokens</p>
            </div>
            {% endif %}

            <div class="grid grid-cols-2 gap-4 text-sm">
                {% if tokens.token_type %}
                <div>
                    <label class="block text-xs font-medium text-gray-700">Token Type</label>
                    <p class="text-gray-900">{{ tokens.token_type }}</p>
                </div>
                {% endif %}
                
                {% if tokens.expires_in %}
                <div>
                    <label class="block text-xs font-medium text-gray-700">Expires In</label>
                    <p class="text-gray-900">{{ tokens.expires_in }} seconds</p>
                </div>
                {% endif %}
                
                {% if tokens.scope %}
                <div class="col-span-2">
                    <label class="block text-xs font-medium text-gray-700">Scope</label>
                    <p class="text-gray-900">{{ tokens.scope }}</p>
                </div>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ID Token Decoded -->
    {% if id_token_decoded %}
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-900 mb-6">Decoded ID Token</h2>
        <div class="bg-gray-50 rounded-md p-4">
            <pre class="text-sm font-mono whitespace-pre-wrap">{{ id_token_decoded | tojson(indent=2) }}</pre>
        </div>
    </div>
    {% endif %}

    <!-- Actions -->
    <div class="mt-8 flex justify-center space-x-4">
        <a href="{{ url_for('index') }}" class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition-colors">
            Back to Home
        </a>
        <a href="{{ url_for('logout') }}" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 transition-colors">
            Logout
        </a>
    </div>
</div>

<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
        button.classList.add('bg-green-600');
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-600');
        }, 2000);
        console.log('Copied to clipboard');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        alert('Failed to copy to clipboard. Please copy manually.');
    });
}

function toggleElement(elementId) {
    const element = document.getElementById(elementId);
    const button = event.target.closest('button');
    
    if (element.classList.contains('hidden')) {
        element.classList.remove('hidden');
        button.innerHTML = '<i class="fas fa-eye-slash mr-1"></i>Hide';
    } else {
        element.classList.add('hidden');
        button.innerHTML = '<i class="fas fa-eye mr-1"></i>Show';
    }
}

function uploadCertificate() {
    const fileInput = document.getElementById('certificateFile');
    const resultDiv = document.getElementById('uploadResult');
    
    if (!fileInput.files || fileInput.files.length === 0) {
        showUploadResult('Please select a certificate file first.', 'error');
        return;
    }
    
    const formData = new FormData();
    formData.append('certificate', fileInput.files[0]);
    
    // Show loading state
    showUploadResult('Uploading certificate...', 'loading');
    
    fetch('/upload_certificate', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showUploadResult(
                `‚úÖ ${data.message}<br>
                <small class="text-green-600">
                Subject: ${data.certificate_info.subject}<br>
                Valid until: ${data.certificate_info.valid_until}<br>
                File: ${data.certificate_info.filename}
                </small><br>
                <small class="text-blue-600 mt-2 block">
                <i class="fas fa-info-circle mr-1"></i>Refresh the page to perform SAML authentication again and see signature verification results.
                </small>`, 
                'success'
            );
            fileInput.value = ''; // Clear the file input
        } else {
            showUploadResult(`‚ùå Upload failed: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        showUploadResult(`‚ùå Upload failed: ${error.message}`, 'error');
    });
}

function showUploadResult(message, type) {
    const resultDiv = document.getElementById('uploadResult');
    resultDiv.classList.remove('hidden');
    
    let className = '';
    switch(type) {
        case 'success':
            className = 'bg-green-50 border-green-200 text-green-700';
            break;
        case 'error':
            className = 'bg-red-50 border-red-200 text-red-700';
            break;
        case 'loading':
            className = 'bg-blue-50 border-blue-200 text-blue-700';
            break;
    }
    
    resultDiv.className = `mt-2 p-2 border rounded text-xs ${className}`;
    resultDiv.innerHTML = message;
}

// Educational enhancements
document.addEventListener('DOMContentLoaded', function() {
    // Automatically show SAML flow timeline with animation
    const flowSteps = document.querySelectorAll('.bg-green-500');
    flowSteps.forEach((step, index) => {
        setTimeout(() => {
            step.style.transform = 'scale(1.1)';
            setTimeout(() => {
                step.style.transform = 'scale(1)';
            }, 200);
        }, index * 300);
    });
});
</script>
{% endblock %} 